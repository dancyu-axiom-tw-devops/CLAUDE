apiVersion: apps/v1
kind: Deployment
metadata:
  name: exchange-service
  namespace: forex-prod
  annotations:
    reloader.stakater.com/auto: "true"
spec:
  selector:
    matchLabels:
      app: exchange-service
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: exchange-service
      annotations:
        ack.aliyun.com/rds_id: rm-3nsb71k9219b22611
        ack.aliyun.com/white_list_name: rds_whitelist
    spec:
      restartPolicy: Always
      nodeSelector:
        env: prod
        role: apps
        project: forex
        team: forex
      automountServiceAccountToken: false
      initContainers:
      - name: fix-permissions
        image: asia-east2-docker.pkg.dev/uu-prod/uu-prod/forex-infra/busybox:1.36
        command: ["sh", "-c", "chown -R 1000:1000 /forex/log/"]
        volumeMounts:
        - name: log
          mountPath: /forex/log/
          subPath: exchange-service
        securityContext:
          runAsUser: 0
      containers:
      - name: exchange-service
        image: asia-east2-docker.pkg.dev/uu-prod/uu-prod/forex/exchange-service/exchange-service-rel
        imagePullPolicy: "Always"
        ports:
        - containerPort: 10320
          name: exchange-port
        resources:
          requests:
            cpu: "1000m"
            memory: "1024Mi"
          limits:
            cpu: "4000m"
            memory: "6144Mi"
        envFrom:
        - secretRef:
            name: exchange-service-env   # 改成 secret 名稱
        livenessProbe:
          tcpSocket:
            port: 10320
          initialDelaySeconds: 45
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 3
          successThreshold: 1
        readinessProbe:
          tcpSocket:
            port: 10320
          initialDelaySeconds: 45
          periodSeconds: 10
          timeoutSeconds: 10
          failureThreshold: 3
          successThreshold: 1
        securityContext:
          runAsUser: 1000
          runAsGroup: 1000
          runAsNonRoot: true
          readOnlyRootFilesystem: false
          allowPrivilegeEscalation: false
          privileged: false
          capabilities:
            drop:
            - ALL
          seccompProfile:
            type: RuntimeDefault
        volumeMounts:
        - name: log
          mountPath: /forex/log/
          subPath: exchange-service
        - name: decryptor
          mountPath: /forex/encrypt/
          subPath: c-shared-so-1.23.4
      volumes:
      - name: log
        persistentVolumeClaim:
          claimName: forex-cnf-nas-log
      - name: decryptor
        persistentVolumeClaim:
          claimName: forex-cnf-nas-dcpt
      # hostAliases:
      #   - ip: "47.76.255.132"
      #     hostnames:
      #       - "api-uu-c2.hyperwaas.com"