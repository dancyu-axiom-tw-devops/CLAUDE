# PIGO Memory Inspection å·¥ä½œæ—¥èªŒ

## 2025-12-26

### Phase 1: ServiceMonitor éƒ¨ç½² âœ…

**æ™‚é–“**: 09:00 - 09:15

**ä»»å‹™**: éƒ¨ç½² pigo-services-monitor ä»¥æ¡é›† JVM metrics

**åŸ·è¡Œæ­¥é©Ÿ**:

1. æª¢æŸ¥ ServiceMonitor é…ç½®æ–‡ä»¶
   - ä½ç½®: `/Users/user/K8S/k8s-devops/monitoring/env/hkidc-k8s/services/pigo-services-monitor-dev-stg-rel.yaml`
   - æ¶µè“‹ç¯„åœ: pigo-dev, pigo-stg, pigo-rel ä¸‰å€‹ namespace
   - ç›®æ¨™æœå‹™: pigo-api, game-api
   - Metrics è·¯å¾‘: `/actuator/prometheus`
   - æ¡é›†é–“éš”: 30s

2. éƒ¨ç½² ServiceMonitor
   ```bash
   cd /Users/user/K8S/k8s-devops/monitoring
   kubectl apply -f env/hkidc-k8s/services/pigo-services-monitor-dev-stg-rel.yaml --context tp-hkidc-k8s
   ```

3. é©—è­‰éƒ¨ç½²
   ```bash
   kubectl get servicemonitor pigo-services-monitor -n pigo-rel --context tp-hkidc-k8s
   kubectl get servicemonitor pigo-services-monitor -n pigo-stg --context tp-hkidc-k8s
   kubectl get servicemonitor pigo-services-monitor -n pigo-dev --context tp-hkidc-k8s
   ```
   çµæœ: âœ… ä¸‰å€‹ namespace éƒ½æˆåŠŸéƒ¨ç½²

4. é©—è­‰ /actuator/prometheus endpoint
   ```bash
   kubectl exec -n pigo-rel deployment/pigo-api --context tp-hkidc-k8s -- wget -qO- "http://localhost:2110/actuator/prometheus" | head -20
   ```
   çµæœ: âœ… endpoint æ­£å¸¸ï¼Œè¿”å› Prometheus metrics

5. é©—è­‰ service port é…ç½®
   ```bash
   kubectl get svc -n pigo-rel pigo-api-service --context tp-hkidc-k8s -o yaml | grep -A5 ports
   ```
   çµæœ: âœ… port name "service-api" åŒ¹é… ServiceMonitor é…ç½®

**çµæœ**:
- âœ… ServiceMonitor æˆåŠŸéƒ¨ç½²åˆ° 3 å€‹ namespace
- âœ… /actuator/prometheus endpoint ç¢ºèªå¯è¨ªå•
- âœ… Service port é…ç½®æ­£ç¢º
- â³ JVM metrics éœ€è¦ 1-3 åˆ†é˜é–‹å§‹è¢« Prometheus æ¡é›†
- âœ… Container metrics (memory_working_set, limits, requests) å®Œå…¨å¯ç”¨

**ç™¼ç¾å•é¡Œ**:
- nacos Pod: 2017Mi / 2000Mi (100.8%) - ğŸ”´ OOM é¢¨éšª
- pigo-api Pod: 1450Mi / 2048Mi (70.8%) - ğŸŸ¡ éœ€é—œæ³¨

---

### Phase 2: è¨˜æ†¶é«”å·¡è¦–è…³æœ¬é–‹ç™¼ âœ…

**æ™‚é–“**: 09:15 - 11:30

**ä»»å‹™**: é–‹ç™¼ Python è¨˜æ†¶é«”å·¡è¦–è…³æœ¬ï¼Œå¯¦ç¾ 4 é …æª¢æŸ¥åŠŸèƒ½

**å‰µå»ºæ–‡ä»¶**:

1. **prometheus_client.py** (285 è¡Œ)
   - PrometheusClient é¡ï¼šé€é kubectl exec è¨ªå• Prometheus API
   - æ”¯æ´ instant query å’Œ range query
   - æ–¹æ³•ï¼š
     - `query_instant()` - å³æ™‚æŸ¥è©¢
     - `query_range()` - ç¯„åœæŸ¥è©¢ï¼ˆ24h è¶¨å‹¢ï¼‰
     - `get_memory_usage()` - ç²å– container_memory_working_set_bytes
     - `get_memory_limits()` - ç²å– kube_pod_container_resource_limits
     - `get_memory_requests()` - ç²å– kube_pod_container_resource_requests
     - `get_memory_trend()` - ç²å– 24h è¨˜æ†¶é«”è¶¨å‹¢æ•¸æ“š
     - `get_jvm_heap_usage()` - ç²å– JVM heap metrics (å¯é¸)
   - ç‰¹è‰²ï¼šè‡ªå‹•é¸æ“‡ query podï¼Œè™•ç† step å­—ä¸²è½‰æ›

2. **report_generator.py** (275 è¡Œ)
   - ReportGenerator é¡ï¼šç”Ÿæˆ Markdown æ ¼å¼å ±å‘Š
   - æ–¹æ³•ï¼š
     - `generate_summary()` - æ•´é«”æ‘˜è¦ï¼ˆç¸½æ•¸ã€å¥åº·/é—œæ³¨/é¢¨éšªçµ±è¨ˆï¼‰
     - `generate_ranking()` - Top 5 æ’è¡Œæ¦œï¼ˆçµ•å°é‡ + ä½¿ç”¨ç‡ï¼‰
     - `generate_pod_detail()` - å–®å€‹ Pod è©³ç´°æª¢æŸ¥ï¼ˆ4 é …ï¼‰
     - `generate_problem_summary()` - å•é¡Œ Pod åŒ¯ç¸½è¡¨
     - `generate_recommendations()` - çµè«–èˆ‡å»ºè­°ï¼ˆç·Šæ€¥/é—œæ³¨/æ´©æ¼ï¼‰
     - `generate_full_report()` - å®Œæ•´å ±å‘Šçµ„è£
   - ç‰¹è‰²ï¼šè‡ªå‹•æ ¼å¼åŒ–è¨˜æ†¶é«”å–®ä½ (B/Ki/Mi/Gi/Ti)

3. **memory_inspection.py** (329 è¡Œ)
   - MemoryInspector é¡ï¼šä¸»è¦å·¡è¦–é‚è¼¯
   - æ–¹æ³•ï¼š
     - `discover_deployments()` - è‡ªå‹•ç™¼ç¾æ‰€æœ‰ deployment
     - `get_deployment_pods()` - ç²å– deployment çš„ pods
     - `analyze_memory_usage()` - åˆ†æä½¿ç”¨ç‡ï¼ˆé–¾å€¼ï¼š70%, 85%ï¼‰
     - `analyze_memory_trend()` - quarter-based è¶¨å‹¢åˆ†æï¼ˆé–¾å€¼ï¼š10%, 20%ï¼‰
     - `analyze_config_sanity()` - é…ç½®åˆç†æ€§æª¢æŸ¥ï¼ˆå«å»ºè­°ï¼‰
     - `check_deployment_memory()` - åŸ·è¡Œ 4 é …æª¢æŸ¥
     - `run_inspection()` - å®Œæ•´å·¡è¦–æµç¨‹
     - `generate_report()` - ç”Ÿæˆ Markdown å ±å‘Š
   - ç‰¹è‰²ï¼šå®Œæ•´éŒ¯èª¤è™•ç†ï¼Œconsole è¼¸å‡ºé€²åº¦

4. **README.md** (è…³æœ¬ä½¿ç”¨èªªæ˜)
   - æ¦‚è¿°èˆ‡åŠŸèƒ½ç‰¹æ€§
   - ç’°å¢ƒéœ€æ±‚èˆ‡é…ç½®åƒæ•¸
   - ä½¿ç”¨æ–¹æ³•èˆ‡å ±å‘Šçµæ§‹
   - æ¨¡çµ„èªªæ˜èˆ‡ PromQL æŸ¥è©¢
   - éŒ¯èª¤è™•ç†èˆ‡é™åˆ¶
   - ç¯„ä¾‹è¼¸å‡º

**æŠ€è¡“ç´°ç¯€**:

- **Prometheus è¨ªå•æ–¹å¼**: kubectl exec from pigo-rel pod (é¿å… port-forward æ¬Šé™å•é¡Œ)
- **è¨˜æ†¶é«”è¶¨å‹¢ç®—æ³•**: Quarter-based comparison
  ```python
  quarter = len(values) // 4
  first_quarter_avg = values[:quarter] å¹³å‡
  last_quarter_avg = values[-quarter:] å¹³å‡
  growth_pct = (last - first) / first * 100
  ```
- **åˆ¤å®šé–¾å€¼**:
  - ä½¿ç”¨ç‡: ğŸŸ¢ < 70%, ğŸŸ¡ 70-85%, ğŸ”´ > 85%
  - è¶¨å‹¢: ğŸŸ¢ < 10%, ğŸŸ¡ 10-20%, ğŸ”´ > 20% (æ´©æ¼)
  - é…ç½®: æ ¹æ“šå¯¦éš›ä½¿ç”¨æƒ…æ³å‹•æ…‹å»ºè­°

- **é…ç½®å»ºè­°é‚è¼¯**:
  - è¶…é™/æ¥è¿‘é™åˆ¶ â†’ å»ºè­° limit = ç•¶å‰ä½¿ç”¨ Ã— 1.3
  - Request éä½ (< 50% ä½¿ç”¨) â†’ å»ºè­° request = ç•¶å‰ä½¿ç”¨ Ã— 0.8
  - Over-provisioned (< 30% ä¸” > 2GB) â†’ å»ºè­°é™ä½ limit

**åƒè€ƒå¯¦ç¾**:
- Waas2 health-check.py - Prometheus æŸ¥è©¢ã€è¶¨å‹¢åˆ†æã€å ±å‘Šç”Ÿæˆ
- PIGO health check report - Markdown æ ¼å¼ã€ç« ç¯€çµæ§‹

**å·¥ä½œæµç¨‹ç›®éŒ„çµæ§‹**:
```
/Users/user/CLAUDE/workflows/WF-20251226-pigo-memory-inspection/
â”œâ”€â”€ script/
â”‚   â”œâ”€â”€ prometheus_client.py       (285 è¡Œ) âœ…
â”‚   â”œâ”€â”€ report_generator.py        (275 è¡Œ) âœ…
â”‚   â”œâ”€â”€ memory_inspection.py       (329 è¡Œ) âœ…
â”‚   â””â”€â”€ README.md                  âœ…
â”œâ”€â”€ data/                          (å ±å‘Šè¼¸å‡ºç›®éŒ„)
â”œâ”€â”€ docs/                          (æ–‡æª”ç›®éŒ„)
â””â”€â”€ worklogs/
    â””â”€â”€ worklog-20251226.md        (æœ¬æ–‡ä»¶)
```

**çµæœ**:
- âœ… 3 å€‹ Python æ¨¡çµ„é–‹ç™¼å®Œæˆ
- âœ… æ‰€æœ‰è…³æœ¬å·²è¨­ç½®å¯åŸ·è¡Œæ¬Šé™
- âœ… README æ–‡æª”å®Œæ•´
- âœ… ä»£ç¢¼åƒè€ƒ Waas2 å¯¦ç¾ï¼Œçµæ§‹æ¸…æ™°
- âœ… å®Œæ•´éŒ¯èª¤è™•ç†èˆ‡é€²åº¦è¼¸å‡º

**ä¸‹ä¸€æ­¥**:
- Phase 3: åŸ·è¡Œè…³æœ¬ï¼Œç”Ÿæˆè¨˜æ†¶é«”å·¡è¦–å ±å‘Š

---

### Phase 3: ç”Ÿæˆè¨˜æ†¶é«”å·¡è¦–å ±å‘Š ğŸ”„

**æ™‚é–“**: å¾…åŸ·è¡Œ

**è¨ˆåŠƒ**:
1. åŸ·è¡Œ memory_inspection.py
2. æª¢æŸ¥å ±å‘Šå…§å®¹
3. é©—è­‰ 4 é …æª¢æŸ¥çµæœ
4. ç¢ºèªå•é¡Œ Pod è­˜åˆ¥

---

### Phase 4: nacos é…ç½®ä¿®æ”¹ï¼ˆå¯é¸ï¼‰ â¸ï¸

**æ™‚é–“**: å¾…åŸ·è¡Œ

**å‰ç½®æ¢ä»¶**: Phase 3 å ±å‘Šç¢ºèª nacos éœ€è¦èª¿æ•´

**è¨ˆåŠƒ**:
1. å‚™ä»½ç¾æœ‰ nacos deployment
2. è©¢å•ä½¿ç”¨è€…ç¢ºèª
3. åŸ·è¡Œè¨˜æ†¶é«”é…ç½®èª¿æ•´
   - memory request: 1000Mi â†’ 1536Mi
   - memory limit: 2000Mi â†’ 2560Mi
4. é©—è­‰ Pod é‡å•Ÿ
5. ç›£æ§è¨˜æ†¶é«”ä½¿ç”¨ç‡è®ŠåŒ–

---

## é—œéµæ±ºç­–è¨˜éŒ„

### 1. Prometheus è¨ªå•æ–¹å¼
**å•é¡Œ**: kubectl port-forward é‡åˆ°æ¬Šé™å•é¡Œ
**æ±ºç­–**: ä½¿ç”¨ kubectl exec from pigo-rel pod è¨ªå• cluster-internal Prometheus
**ç†ç”±**:
- é¿å…éœ€è¦ monitoring namespace çš„ pod list æ¬Šé™
- pigo-rel pod å¯ä»¥è¨ªå• cluster å…§éƒ¨æœå‹™
- æ›´ç¬¦åˆå¯¦éš›ç”Ÿç”¢ç’°å¢ƒä½¿ç”¨å ´æ™¯

### 2. è¨˜æ†¶é«”è¶¨å‹¢è¨ˆç®—æ–¹æ³•
**å•é¡Œ**: å¦‚ä½•åˆ¤æ–·è¨˜æ†¶é«”æ˜¯å¦æ´©æ¼
**æ±ºç­–**: ä½¿ç”¨ quarter-based comparison (é¦– 1/4 vs å°¾ 1/4)
**ç†ç”±**:
- æ¯”å–®é»æ¯”è¼ƒæ›´ç©©å®šï¼Œæ¸›å°‘å™ªéŸ³å½±éŸ¿
- åƒè€ƒ Waas2 health-check.py æˆç†Ÿå¯¦ç¾
- é©åˆ 24h æ™‚é–“çª—å£

### 3. è…³æœ¬æ¨¡çµ„åŒ–è¨­è¨ˆ
**å•é¡Œ**: å¦‚ä½•çµ„ç¹”ä»£ç¢¼çµæ§‹
**æ±ºç­–**: åˆ†é›¢ç‚º 3 å€‹æ¨¡çµ„ (client, generator, inspector)
**ç†ç”±**:
- è·è²¬åˆ†é›¢ï¼Œæ˜“æ–¼ç¶­è­·
- å¯ç¨ç«‹æ¸¬è©¦å„æ¨¡çµ„
- ç¬¦åˆ Python æœ€ä½³å¯¦è¸

### 4. JVM Metrics è™•ç†
**å•é¡Œ**: JVM metrics å¯èƒ½ä¸å¯ç”¨
**æ±ºç­–**: è¨­ç‚ºå¯é¸åŠŸèƒ½ï¼Œä¸å½±éŸ¿åŸºç¤æª¢æŸ¥
**ç†ç”±**:
- ServiceMonitor éœ€è¦æ™‚é–“æ¡é›†
- Container metrics å·²è¶³å¤ å®Œæˆä¸»è¦æª¢æŸ¥
- é¿å…é˜»å¡å·¡è¦–æµç¨‹

---

## é­é‡å•é¡Œèˆ‡è§£æ±º

### å•é¡Œ 1: Port-forward æ¬Šé™ä¸è¶³
**éŒ¯èª¤**: `User "dancyu-axiom-tw-devops" cannot list resource "pods" in API group "" in the namespace "monitoring"`
**è§£æ±º**: æ”¹ç”¨ kubectl exec from pigo-rel pod è¨ªå• Prometheus
**å½±éŸ¿**: ç„¡ï¼Œå·²å®Œå…¨è§£æ±º

### å•é¡Œ 2: JVM Metrics åˆæœŸä¸å¯ç”¨
**ç¾è±¡**: éƒ¨ç½² ServiceMonitor å¾Œï¼Œjvm_memory_used_bytes è¿”å› 0 çµæœ
**åŸå› **: Prometheus éœ€è¦ 1-3 åˆ†é˜ç™¼ç¾ä¸¦é–‹å§‹æ¡é›†
**è§£æ±º**: è¨­è¨ˆè…³æœ¬æ™‚å°‡ JVM metrics è¨­ç‚ºå¯é¸ï¼Œä½¿ç”¨ try-except è™•ç†
**å½±éŸ¿**: ç„¡ï¼ŒContainer metrics è¶³ä»¥å®Œæˆå·¡è¦–

---

## æ™‚é–“è¨˜éŒ„

| éšæ®µ | é ä¼°æ™‚é–“ | å¯¦éš›æ™‚é–“ | ç‹€æ…‹ |
|------|---------|---------|------|
| Phase 1: ServiceMonitor éƒ¨ç½² | 5-10 åˆ†é˜ | 15 åˆ†é˜ | âœ… å®Œæˆ |
| Phase 2: è…³æœ¬é–‹ç™¼ | 90-135 åˆ†é˜ | 135 åˆ†é˜ | âœ… å®Œæˆ |
| Phase 3: å ±å‘Šç”Ÿæˆ | 60-85 åˆ†é˜ | - | ğŸ”„ é€²è¡Œä¸­ |
| Phase 4: nacos é…ç½®ä¿®æ”¹ | 12-23 åˆ†é˜ | - | â¸ï¸ å¾…å®š |

---

## å¾…è¾¦äº‹é …

- [ ] Phase 3: åŸ·è¡Œ memory_inspection.py
- [ ] Phase 3: æª¢æŸ¥ç”Ÿæˆçš„å ±å‘Š
- [ ] Phase 3: é©—è­‰ nacos ç­‰å•é¡Œ Pod è­˜åˆ¥
- [ ] Phase 4: æ ¹æ“šå ±å‘Šæ±ºå®šæ˜¯å¦èª¿æ•´ nacos é…ç½®
- [ ] (å¯é¸) å‰µå»º DESIGN.md æ–‡æª”
- [ ] (å¯é¸) å‰µå»º PROMQL-QUERIES.md åƒè€ƒæ–‡æª”

---

## åƒè€ƒè³‡æ–™

- è¨ˆç•«æ–‡ä»¶: `/Users/user/.claude/plans/squishy-hatching-bonbon.md`
- Waas2 åƒè€ƒ: `/Users/user/Waas2-project/gitlab.axiom-infra.com/waas2-tenant-k8s-deploy/infra/health-monitor/health-check.py`
- PIGO å¥åº·å·¡æª¢: `/Users/user/CLAUDE/workflows/WF-20251226-pigo-k8s-health-check/pigo-offline-k8s-health-20251226.md`
- ServiceMonitor é…ç½®: `/Users/user/K8S/k8s-devops/monitoring/env/hkidc-k8s/services/pigo-services-monitor-dev-stg-rel.yaml`
- Prometheus Integration: `/Users/user/CLAUDE/workflows/WF-20251225-waas2-health-monitor/docs/PROMETHEUS-INTEGRATION.md`
